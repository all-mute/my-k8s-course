# Kubernetes: Service

---

В Kubernetes `Service` — это объект, который предоставляет сетевой доступ к одному или нескольким подам. `Service` абстрагирует доступ к группе подов, обеспечивая постоянный IP-адрес и DNS-имя, даже если поды пересоздаются. Существует несколько типов `Service`, каждый из которых подходит для разных сетевых нужд и сценариев.

### 1. ClusterIP
**ClusterIP** — это тип `Service` по умолчанию. Он создает виртуальный IP-адрес, доступный только внутри кластера Kubernetes. Внешние запросы к ClusterIP не допускаются.

- **Применение**: используется для внутреннего взаимодействия между сервисами в кластере, когда необходимо скрыть сервис от внешних клиентов.
- **Пример**: Веб-приложение и база данных, развернутые в кластере, могут обмениваться данными через ClusterIP.
  
Пример манифеста для создания ClusterIP Service:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-clusterip-service
spec:
  type: ClusterIP
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
```
В этом примере Service направляет трафик на все поды с меткой `app: my-app` и перенаправляет его на порт 8080.

### 2. NodePort
**NodePort** — это тип `Service`, который открывает порт на всех узлах (нодах) кластера, позволяя доступ к подам извне кластера через IP-адреса узлов.

- **Применение**: обеспечивает доступ к сервису из-за пределов кластера без балансировщика нагрузки. NodePort резервирует порт в диапазоне 30000-32767.
- **Особенности**: при использовании NodePort, запросы направляются на любой узел кластера по порту NodePort, а затем перенаправляются на целевой под.
  
Пример манифеста для создания NodePort Service:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-nodeport-service
spec:
  type: NodePort
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      nodePort: 30001
```
Здесь сервис будет доступен на всех узлах по `node-ip:30001`, перенаправляя трафик на порт 8080 в подах.

### 3. LoadBalancer
**LoadBalancer** — это тип `Service`, который создаёт внешний балансировщик нагрузки, доступный извне кластера, и автоматически распределяет трафик по подам.

- **Применение**: используется для создания внешних публичных сервисов, которые должны быть доступны через интернет.
- **Особенности**: требует поддержки балансировщика нагрузки от облачного провайдера (например, AWS, Google Cloud). Обычно создает внешний IP-адрес для доступа к сервису.
  
Пример манифеста для создания LoadBalancer Service:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-loadbalancer-service
spec:
  type: LoadBalancer
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
```
Kubernetes запрашивает у облачного провайдера внешний IP-адрес и настраивает его как точку входа в сервис.

### 4. ExternalIPs
**ExternalIPs** — это настройка, которая позволяет направить внешний IP-адрес на `Service` с типом `ClusterIP` или `NodePort`.

- **Применение**: используется, если вы хотите сделать сервис доступным по внешнему IP, но у вас нет LoadBalancer. Этот IP-адрес должен быть привязан к одному из узлов и настроен так, чтобы перенаправлять запросы на него к соответствующему Service.
- **Особенности**: IP-адрес должен быть статическим и закреплен за узлом кластера вне Kubernetes.
  
Пример манифеста с использованием ExternalIPs:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-externalip-service
spec:
  type: ClusterIP
  selector:
    app: my-app
  externalIPs:
    - 192.168.1.100
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
```
В этом случае сервис будет доступен по IP `192.168.1.100`, и запросы будут перенаправляться на порт 8080 в подах с меткой `app: my-app`.

### Сравнение типов Service:
| Тип           | Описание                                           | Доступность               | Применение                    |
|---------------|----------------------------------------------------|---------------------------|--------------------------------|
| ClusterIP     | Доступен только внутри кластера                    | Внутренний                | Взаимодействие между сервисами |
| NodePort      | Доступен снаружи через IP-адреса узлов             | Внешний и внутренний      | Локальный доступ извне         |
| LoadBalancer  | Доступен снаружи через балансировщик нагрузки      | Внешний (облако)          | Публичные сервисы              |
| ExternalIPs   | Прямой доступ через внешний IP                     | Внешний (статический IP)  | Специальные случаи             |

Эти типы Service позволяют гибко организовать сетевую архитектуру для приложений в Kubernetes в зависимости от их требований к доступу и распределению нагрузки.