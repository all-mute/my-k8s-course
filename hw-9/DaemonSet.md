# Kubernetes: DaemonSet

---

### DaemonSet в Kubernetes: Подробное объяснение

**DaemonSet** — это объект в Kubernetes, который гарантирует, что копия пода будет запущена на каждом узле в кластере или на узлах, удовлетворяющих определенным условиям (например, только на узлах с определенным лейблом). **DaemonSet** полезен для развертывания подов, которые должны работать на всех узлах, например, для системных агентов (логирование, мониторинг, сбор метрик) или сетевых приложений.

### Основные особенности DaemonSet

- **Одновременно на всех узлах**: DaemonSet гарантирует, что копия пода будет работать на каждом узле в кластере, включая новые узлы, которые добавляются в кластер.
- **Подходит для системных приложений**: Это идеальный способ развернуть такие приложения, как агенты мониторинга, сборщики логов, прокси-серверы и сетевые инструменты, которые должны работать на каждом узле.
- **Поддержка обновлений**: DaemonSet можно обновлять и масштабировать. Kubernetes может постепенно обновлять версии подов, чтобы минимизировать возможные сбои.

### Основные параметры DaemonSet

1. **replicas**: В отличие от других ресурсов (например, `Deployment`), DaemonSet обычно управляет только одной репликой пода на каждом узле. Параметр `replicas` не используется в DaemonSet, так как поды запускаются на всех узлах автоматически.
  
2. **selector**: Определяет, какие поды следует управлять. По умолчанию создается селектор, который соответствует меткам, заданным в `template.metadata.labels`. Это позволяет DaemonSet контролировать создание и удаление подов.

3. **template**: Это шаблон пода, который будет использован для развертывания подов на узлах. В нем указывается образ контейнера, переменные окружения и другие параметры, такие как монтируемые тома и порты.

4. **updateStrategy**: Определяет, как обновлять поды при изменении манифеста DaemonSet. Есть два типа:
   - **RollingUpdate** (по умолчанию): Поды обновляются постепенно.
   - **OnDelete**: Поды обновляются только при явном удалении старого пода.

5. **nodeSelector**: Этот параметр позволяет ограничить запуск подов на узлы с определенными метками. Например, вы можете запустить DaemonSet только на узлах с определенным типом железа или операционной системой.

6. **tolerations**: Если вы хотите, чтобы DaemonSet запускался на узлах с определенными "taints" (например, узлы с метками, которые блокируют запуск подов), можно использовать `tolerations`.

7. **affinity**: Параметр для настройки более сложных правил расположения подов на узлах.

### Преимущества и назначение DaemonSet

1. **Гарантированное присутствие на каждом узле**: Если приложение должно работать на каждом узле (например, агенты логирования, мониторинга), DaemonSet автоматически создает поды на всех узлах и управляет их жизненным циклом.
   
2. **Обновление подов по-очереди**: DaemonSet поддерживает стратегию обновлений, чтобы обновлять поды по очереди, минимизируя сбоев.

3. **Поддержка новых узлов**: Когда добавляется новый узел в кластер, DaemonSet автоматически создает под на этом узле.

### Пример манифеста DaemonSet для Fluentd (агент логирования)

Предположим, что вам нужно развернуть Fluentd, который будет собирать логи с каждого узла и отправлять их в центральную систему. Используем DaemonSet для этой цели.

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  labels:
    app: fluentd
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd:v1.13-1
        ports:
        - containerPort: 24224
        volumeMounts:
        - name: fluentd-config
          mountPath: /fluentd/etc
          subPath: fluentd.conf
        - name: fluentd-logs
          mountPath: /var/log
  volumes:
  - name: fluentd-config
    configMap:
      name: fluentd-config
  - name: fluentd-logs
    hostPath:
      path: /var/log
```

### Объяснение манифеста

- **selector**: Указывает, что DaemonSet будет работать с подами, метки которых соответствуют `app: fluentd`.
- **template**:
  - Контейнер Fluentd с образом `fluent/fluentd:v1.13-1`.
  - Порты, которые будут слушать контейнер.
  - `volumeMounts` для подключения конфигурации Fluentd и логов с хоста (`hostPath` для логов).
- **volumes**:
  - `fluentd-config` указывает на `ConfigMap`, содержащий конфигурацию Fluentd.
  - `fluentd-logs` использует `hostPath` для монтирования локальных логов на хосте в контейнер.

### Применение манифеста

1. Сначала создайте ConfigMap с конфигурацией для Fluentd (если она есть).
2. Примените DaemonSet:
   ```bash
   kubectl apply -f fluentd-daemonset.yaml
   ```

3. Проверьте, что DaemonSet работает:
   ```bash
   kubectl get daemonset
   kubectl get pods
   ```

### Управление DaemonSet

- **Обновление DaemonSet**:
  Вы можете обновить DaemonSet, изменив манифест и применив его снова. Kubernetes будет обновлять поды постепенно.

  ```bash
  kubectl apply -f fluentd-daemonset.yaml
  ```

- **Удаление DaemonSet**:
  Для удаления DaemonSet и связанных с ним подов выполните команду:
  
  ```bash
  kubectl delete daemonset fluentd
  ```

### Заключение

`DaemonSet` — это мощный инструмент для развертывания приложений, которые должны работать на всех узлах в кластере Kubernetes, например, для мониторинга, сбора логов или сетевых приложений. С помощью DaemonSet Kubernetes гарантирует, что ваш контейнер будет запущен на каждом узле и будет автоматически управлять его жизненным циклом.
